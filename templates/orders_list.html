{% extends "base.html" %}
{% block title %}Orders List{% endblock %}
{% block content %}
<div class="main">
<div class="card">
<h2>ğŸ“¦ Orders List</h2>
<p style="color: #666; margin-bottom: 20px;">æŒ‰æ—¥æœŸåˆ†é¡é¡¯ç¤ºæ‰€æœ‰è¨‚å–®</p>

<!-- æ—¥æœŸç¯©é¸ -->
<div class="filter-container">
<label for="dateFilter">é¸æ“‡æ—¥æœŸ:</label>
<input type="date" id="dateFilter" onchange="filterByDate()">
<button onclick="clearDateFilter()" class="btn-clear">é¡¯ç¤ºå…¨éƒ¨</button>
</div>

<!-- è¨‚å–®çµ±è¨ˆ -->
<div class="stats-container">
<div class="stat-card">
<div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
<div id="totalOrders" class="stat-value">0</div>
</div>
<div class="stat-card">
<div class="stat-label">ç¸½é‡‘é¡</div>
<div id="totalAmount" class="stat-value">$0.00</div>
</div>
<div class="stat-card">
<div class="stat-label">ä»Šæ—¥è¨‚å–®</div>
<div id="todayOrders" class="stat-value">0</div>
</div>
</div>

<!-- è¨‚å–®åˆ—è¡¨ -->
<div id="ordersContainer" class="orders-container"></div>
</div>
</div>

<style>
.filter-container {
display: flex;
align-items: center;
gap: 10px;
margin: 20px 0;
padding: 15px;
background-color: #f8f9fa;
border-radius: 8px;
}

.filter-container label {
font-weight: bold;
color: #264653;
}

#dateFilter {
padding: 8px 12px;
border: 2px solid #2a9d8f;
border-radius: 4px;
font-size: 1em;
}

#dateFilter:focus {
outline: none;
border-color: #21867a;
}

.btn-clear {
padding: 8px 20px;
background-color: #6c757d;
color: white;
border: none;
border-radius: 4px;
cursor: pointer;
font-size: 1em;
}

.btn-clear:hover {
background-color: #5a6268;
}

.stats-container {
display: flex;
gap: 15px;
margin: 20px 0;
}

.stat-card {
flex: 1;
background: linear-gradient(135deg, #2a9d8f 0%, #21867a 100%);
color: white;
padding: 20px;
border-radius: 8px;
text-align: center;
box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.stat-label {
font-size: 0.9em;
opacity: 0.9;
margin-bottom: 10px;
}

.stat-value {
font-size: 2em;
font-weight: bold;
}

.orders-container {
margin-top: 20px;
}

.date-group {
margin-bottom: 30px;
}

.date-header {
background-color: #264653;
color: white;
padding: 12px 20px;
border-radius: 8px;
font-weight: bold;
font-size: 1.1em;
margin-bottom: 15px;
display: flex;
justify-content: space-between;
align-items: center;
}

.date-count {
background-color: rgba(255,255,255,0.2);
padding: 5px 15px;
border-radius: 20px;
font-size: 0.9em;
}

.order-item {
background-color: #f9f9f9;
border: 1px solid #ddd;
border-radius: 8px;
padding: 15px;
margin-bottom: 10px;
cursor: pointer;
transition: all 0.2s;
display: flex;
justify-content: space-between;
align-items: center;
}

.order-item:hover {
transform: translateX(5px);
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
background-color: #f0f0f0;
}

.order-info {
flex: 1;
}

.order-invoice {
font-weight: bold;
color: #264653;
font-size: 1.1em;
margin-bottom: 5px;
}

.order-details {
color: #666;
font-size: 0.9em;
}

.order-customer {
color: #2a9d8f;
font-weight: bold;
}

.order-price {
font-size: 1.3em;
font-weight: bold;
color: #e76f51;
text-align: right;
}

.order-time {
font-size: 0.85em;
color: #999;
}

.no-orders {
text-align: center;
padding: 40px;
color: #666;
font-size: 1.1em;
}

.order-status-badge {
display: inline-block;
padding: 4px 12px;
border-radius: 12px;
font-size: 0.85em;
font-weight: bold;
margin-left: 10px;
}

.status-pending {
background-color: #ffd60a;
color: #333;
}

.status-completed {
background-color: #52b788;
color: white;
}

.status-cancelled {
background-color: #e76f51;
color: white;
}
</style>

<script>
let allOrders = [];
let filteredOrders = [];

// é é¢è¼‰å…¥æ™‚ç²å–è¨‚å–®
window.addEventListener('DOMContentLoaded', function() {
loadOrders();
});

// è¼‰å…¥è¨‚å–®
function loadOrders() {
fetch('/api/orders')
.then(response => {
if (!response.ok) {
throw new Error('Network response was not ok');
}
return response.json();
})
.then(orders => {
allOrders = orders;
filteredOrders = orders;
updateStats();
displayOrdersByDate();
})
.catch(error => {
console.error('Error loading orders:', error);
document.getElementById('ordersContainer').innerHTML =
'<div class="no-orders" style="color: red;">è¼‰å…¥è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
});
}

// æ›´æ–°çµ±è¨ˆæ•¸æ“š
function updateStats() {
const totalOrders = filteredOrders.length;
const totalAmount = filteredOrders.reduce((sum, order) => sum + order.total_price, 0);
const today = new Date().toISOString().split('T')[0];
const todayOrders = filteredOrders.filter(order => 
order.order_date.startsWith(today)
).length;

document.getElementById('totalOrders').textContent = totalOrders;
document.getElementById('totalAmount').textContent = `$${totalAmount.toFixed(2)}`;
document.getElementById('todayOrders').textContent = todayOrders;
}

// æŒ‰æ—¥æœŸé¡¯ç¤ºè¨‚å–®
function displayOrdersByDate() {
const container = document.getElementById('ordersContainer');
container.innerHTML = '';

if (filteredOrders.length === 0) {
container.innerHTML = '<div class="no-orders">ç›®å‰æ²’æœ‰è¨‚å–®è³‡æ–™</div>';
return;
}

// æŒ‰æ—¥æœŸåˆ†çµ„
const ordersByDate = {};
filteredOrders.forEach(order => {
const date = order.order_date.split(' ')[0];
if (!ordersByDate[date]) {
ordersByDate[date] = [];
}
ordersByDate[date].push(order);
});

// æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
const sortedDates = Object.keys(ordersByDate).sort((a, b) => b.localeCompare(a));

// é¡¯ç¤ºæ¯å€‹æ—¥æœŸçš„è¨‚å–®
sortedDates.forEach(date => {
const orders = ordersByDate[date];
const dateGroup = document.createElement('div');
dateGroup.className = 'date-group';

const dateHeader = document.createElement('div');
dateHeader.className = 'date-header';
dateHeader.innerHTML = `
<span>${date}</span>
<span class="date-count">${orders.length} ç­†è¨‚å–®</span>
`;
dateGroup.appendChild(dateHeader);

orders.forEach(order => {
const orderItem = document.createElement('div');
orderItem.className = 'order-item';
orderItem.onclick = () => viewOrder(order.id);

const statusClass = `status-${order.status.toLowerCase()}`;
const time = order.order_date.split(' ')[1];

orderItem.innerHTML = `
<div class="order-info">
<div class="order-invoice">
${order.invoice_number}
<span class="order-status-badge ${statusClass}">${order.status}</span>
</div>
<div class="order-details">
<span class="order-customer">${order.customer_name}</span> | 
${order.product_name} Ã— ${order.quantity}
</div>
<div class="order-time">${time}</div>
</div>
<div class="order-price">$${order.total_price.toFixed(2)}</div>
`;
dateGroup.appendChild(orderItem);
});

container.appendChild(dateGroup);
});
}

// æŒ‰æ—¥æœŸç¯©é¸
function filterByDate() {
const dateInput = document.getElementById('dateFilter').value;
if (!dateInput) {
filteredOrders = allOrders;
} else {
filteredOrders = allOrders.filter(order => 
order.order_date.startsWith(dateInput)
);
}
updateStats();
displayOrdersByDate();
}

// æ¸…é™¤æ—¥æœŸç¯©é¸
function clearDateFilter() {
document.getElementById('dateFilter').value = '';
filteredOrders = allOrders;
updateStats();
displayOrdersByDate();
}

// æŸ¥çœ‹è¨‚å–®è©³æƒ…
function viewOrder(orderId) {
window.location.href = `/invoices/edit/${orderId}`;
}
</script>
{% endblock %}