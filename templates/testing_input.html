{% extends "base.html" %}
{% block title %}Testing Input - Shopping Cart{% endblock %}
{% block content %}
<div class="main">
<div class="card">
<div class="user-info-bar">
<span id="currentUser">Welcome</span>
</div>
<h2>ðŸ›’ Testing Input - Shopping Cart</h2>
<p style="color: #666; margin-bottom: 20px;">Test order input functionality</p>

<!-- ç•¶å‰è³¼ç‰©è»Šå…§å®¹é¡¯ç¤º -->
<div id="cartDisplay" class="cart-display">
<h3>Current Cart Items:</h3>
<div id="cartItems" class="cart-items">
<p style="color: #999;">Cart is empty</p>
</div>
</div>

<!-- è¼¸å…¥è¡¨å–® -->
<div class="input-section">
<h3>Add Item to Cart</h3>

<div class="form-group">
<label>Product ID:</label>
<input id="productId" placeholder="Enter Product ID (e.g.: PROD001)" type="text">
<div id="productInfo" class="info-display"></div>
</div>

<div class="form-group">
<label>Customer ID:</label>
<input id="customerId" placeholder="Enter Customer ID (e.g.: 1)" type="number">
<div id="customerInfo" class="info-display"></div>
</div>

<div class="form-group">
<label>Quantity:</label>
<input id="quantity" placeholder="Quantity" type="number" min="1" value="1">
</div>

<div class="form-group">
<label>Delivery Date:</label>
<input id="deliveryDate" type="date" class="delivery-date-input">
<small style="color: #666; display: block; margin-top: 5px;">Select delivery date (optional)</small>
</div>

<div class="button-group">
<button onclick="addToCart()" class="btn-primary">Add to Cart</button>
<button onclick="clearCart()" class="btn-secondary">Clear Cart</button>
<button onclick="submitOrder()" class="btn-success">Submit Order</button>
</div>
</div>
</div>
</div>

<style>
.cart-display {
background-color: #f8f9fa;
border: 2px solid #2a9d8f;
border-radius: 8px;
padding: 20px;
margin-bottom: 30px;
}

.cart-display h3 {
color: #2a9d8f;
margin-bottom: 15px;
}

.cart-items {
min-height: 100px;
}

.cart-item {
background-color: white;
border: 1px solid #ddd;
border-radius: 6px;
padding: 15px;
margin-bottom: 10px;
display: flex;
justify-content: space-between;
align-items: center;
}

.cart-item-info {
flex: 1;
}

.cart-item-name {
font-weight: bold;
font-size: 1.1em;
color: #264653;
margin-bottom: 5px;
}

.cart-item-details {
color: #666;
font-size: 0.9em;
}

.cart-item-price {
color: #2a9d8f;
font-size: 1.2em;
font-weight: bold;
text-align: right;
}

.cart-item-remove {
background-color: #e76f51;
color: white;
border: none;
padding: 8px 15px;
border-radius: 4px;
cursor: pointer;
margin-left: 15px;
}

.cart-item-remove:hover {
background-color: #d15b42;
}

.input-section {
background-color: #fff;
padding: 20px;
border-radius: 8px;
}

.form-group {
margin-bottom: 20px;
}

.form-group label {
display: block;
font-weight: bold;
margin-bottom: 8px;
color: #264653;
}

input {
width: 100%;
padding: 10px;
border: 2px solid #ddd;
border-radius: 4px;
font-size: 1em;
box-sizing: border-box;
}

input:focus {
outline: none;
border-color: #2a9d8f;
}

.delivery-date-input {
border: 2px solid #2a9d8f;
cursor: pointer;
}

.delivery-date-input:focus {
border-color: #21867a;
}

.info-display {
margin-top: 10px;
padding: 10px;
background-color: #e8f5f3;
border-radius: 4px;
min-height: 20px;
}

.info-success {
color: #2a9d8f;
font-weight: bold;
}

.info-error {
color: #e76f51;
font-weight: bold;
}

.button-group {
display: flex;
gap: 10px;
margin-top: 25px;
}

button {
flex: 1;
padding: 12px;
border: none;
border-radius: 4px;
cursor: pointer;
font-size: 1em;
font-weight: bold;
}

.btn-primary {
background-color: #2a9d8f;
color: white;
}

.btn-primary:hover {
background-color: #21867a;
}

.btn-secondary {
background-color: #6c757d;
color: white;
}

.btn-secondary:hover {
background-color: #5a6268;
}

.btn-success {
background-color: #52b788;
color: white;
}

.btn-success:hover {
background-color: #40916c;
}

.cart-summary {
background-color: #264653;
color: white;
padding: 15px;
border-radius: 6px;
margin-top: 15px;
text-align: right;
}

.cart-summary-total {
font-size: 1.5em;
font-weight: bold;
}

.user-info-bar {
    background-color: #f8f9fa;
    padding: 10px 15px;
    border-radius: 6px;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#currentUser {
    color: #264653;
    font-weight: 600;
}

</style>

<script>
let cart = [];
let currentProduct = null;
let currentCustomer = null;

// é é¢è¼‰å…¥æ™‚ç²å–ç”¨æˆ¶ä¿¡æ¯
window.addEventListener('DOMContentLoaded', function() {
    fetch('/api/auth/check-session', {
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.logged_in) {
            document.getElementById('currentUser').textContent = `Welcome, ${data.username}`;
        } else {
            window.location.href = '/login';
        }
    });
});

// ç›£è½ç”¢å“ ID è¼¸å…¥
document.getElementById('productId').addEventListener('blur', function() {
const productId = this.value.trim();
if (productId) {
fetchProductInfo(productId);
}
});

// ç›£è½å®¢æˆ¶ ID è¼¸å…¥
document.getElementById('customerId').addEventListener('blur', function() {
const customerId = this.value.trim();
if (customerId) {
fetchCustomerInfo(customerId);
}
});

// ç²å–ç”¢å“ä¿¡æ¯
function fetchProductInfo(productId) {
fetch(`/api/products/${productId}`)
.then(response => {
if (!response.ok) {
throw new Error('Product not found');
}
return response.json();
})
.then(product => {
currentProduct = product;
const infoDiv = document.getElementById('productInfo');
infoDiv.innerHTML = `
<div class="info-success">
âœ“ Product Name: ${product.name} | Price: $${product.price} | Category: ${product.subclass}
</div>
`;
})
.catch(error => {
currentProduct = null;
document.getElementById('productInfo').innerHTML = `
<div class="info-error">âœ— Product ID not found: ${productId}</div>
`;
});
}

// ç²å–å®¢æˆ¶ä¿¡æ¯
function fetchCustomerInfo(customerId) {
fetch(`/api/customers/${customerId}`)
.then(response => {
if (!response.ok) {
throw new Error('Customer not found');
}
return response.json();
})
.then(customer => {
currentCustomer = customer;
const infoDiv = document.getElementById('customerInfo');
infoDiv.innerHTML = `
<div class="info-success">
âœ“ Customer Name: ${customer.name} | Email: ${customer.email}
</div>
`;
})
.catch(error => {
currentCustomer = null;
document.getElementById('customerInfo').innerHTML = `
<div class="info-error">âœ— Customer ID not found: ${customerId}</div>
`;
});
}

// æ·»åŠ åˆ°è³¼ç‰©è»Š
function addToCart() {
if (!currentProduct) {
alert('Please enter a valid Product ID');
return;
}

if (!currentCustomer) {
alert('Please enter a valid Customer ID');
return;
}

const quantity = parseInt(document.getElementById('quantity').value);
if (!quantity || quantity <= 0) {
alert('Please enter a valid quantity');
return;
}

const deliveryDate = document.getElementById('deliveryDate').value;

const cartItem = {
product: currentProduct,
customer: currentCustomer,
quantity: quantity,
deliveryDate: deliveryDate || null,
totalPrice: currentProduct.price * quantity
};

cart.push(cartItem);
updateCartDisplay();

// æ¸…ç©ºè¼¸å…¥
document.getElementById('productId').value = '';
document.getElementById('customerId').value = '';
document.getElementById('quantity').value = '1';
document.getElementById('deliveryDate').value = '';
document.getElementById('productInfo').innerHTML = '';
document.getElementById('customerInfo').innerHTML = '';
currentProduct = null;
currentCustomer = null;

alert('Added to cart!');
}

// æ›´æ–°è³¼ç‰©è»Šé¡¯ç¤º
function updateCartDisplay() {
const cartItemsDiv = document.getElementById('cartItems');

if (cart.length === 0) {
cartItemsDiv.innerHTML = '<p style="color: #999;">Cart is empty</p>';
return;
}

let html = '';
let grandTotal = 0;

cart.forEach((item, index) => {
grandTotal += item.totalPrice;
const deliveryInfo = item.deliveryDate ? `Delivery: ${item.deliveryDate}` : 'No delivery date set';
html += `
<div class="cart-item">
<div class="cart-item-info">
<div class="cart-item-name">${item.product.name}</div>
<div class="cart-item-details">
Customer: ${item.customer.name} | 
Product ID: ${item.product.id} | 
Unit Price: $${item.product.price} | 
Quantity: ${item.quantity}
</div>
<div class="cart-item-details" style="color: #e76f51; margin-top: 5px;">
ðŸ“… ${deliveryInfo}
</div>
</div>
<div class="cart-item-price">$${item.totalPrice.toFixed(2)}</div>
<button class="cart-item-remove" onclick="removeFromCart(${index})">Remove</button>
</div>
`;
});

html += `
<div class="cart-summary">
<div>Total: <span class="cart-summary-total">$${grandTotal.toFixed(2)}</span></div>
<div style="font-size: 0.9em; margin-top: 5px;">${cart.length} items</div>
</div>
`;

cartItemsDiv.innerHTML = html;
}

// å¾žè³¼ç‰©è»Šç§»é™¤
function removeFromCart(index) {
cart.splice(index, 1);
updateCartDisplay();
}

// æ¸…ç©ºè³¼ç‰©è»Š
function clearCart() {
if (cart.length === 0) {
alert('Cart is already empty');
return;
}

if (confirm('Are you sure you want to clear the cart?')) {
cart = [];
updateCartDisplay();
}
}

// æäº¤è¨‚å–®
function submitOrder() {
if (cart.length === 0) {
alert('Cart is empty, cannot submit order');
return;
}

if (!confirm(`Are you sure you want to submit ${cart.length} orders?`)) {
return;
}

// æŒ‰å®¢æˆ¶å’Œé€è²¨æ—¥æœŸåˆ†çµ„è¨‚å–®
const groupedOrders = {};

cart.forEach(item => {
const key = `${item.customer.id}_${item.deliveryDate || 'no-date'}`;
if (!groupedOrders[key]) {
groupedOrders[key] = {
customer_id: item.customer.id,
delivery_date: item.deliveryDate,
items: []
};
}
groupedOrders[key].items.push({
product_id: item.product.id,
quantity: item.quantity
});
});

// ç‚ºæ¯çµ„å‰µå»ºç™¼ç¥¨
const promises = Object.values(groupedOrders).map(orderGroup => {
return fetch('/api/invoices/create', {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(orderGroup)
});
});

Promise.all(promises)
.then(responses => Promise.all(responses.map(r => r.json())))
.then(results => {
alert(`Successfully created/updated ${results.length} invoice(s)!`);
cart = [];
updateCartDisplay();
// è·³è½‰åˆ°ç™¼ç¥¨åˆ—è¡¨
window.location.href = '/invoices';
})
.catch(error => {
console.error('Error submitting orders:', error);
alert('Error occurred while submitting orders');
});
}
</script>
{% endblock %}