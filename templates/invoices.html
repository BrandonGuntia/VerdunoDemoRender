{% extends "base.html" %}
{% block title %}Invoices System{% endblock %}
{% block content %}
<div class="main">
<div class="card">
<h2>üìÑ Invoices System</h2>
<p style="color: #666; margin-bottom: 20px;">Display all invoices grouped by delivery date</p>

<!-- ÊêúÁ¥¢ÂíåÁØ©ÈÅ∏Ê¨Ñ -->
<div class="filter-container">
<input id="searchInput" type="text" placeholder="üîç Search by Invoice Number or Customer Name..." onkeyup="handleSearch(event)" style="flex: 2;">
<label for="dateFilter">Delivery Date:</label>
<input type="date" id="dateFilter" onchange="filterByDate()">
<button onclick="clearFilters()" class="btn-clear">Show All</button>
</div>

<!-- Áµ±Ë®àÊï∏Êìö -->
<div class="stats-container">
<div class="stat-card">
<div class="stat-label">Total Invoices</div>
<div id="totalInvoices" class="stat-value">0</div>
</div>
<div class="stat-card">
<div class="stat-label">Total Amount</div>
<div id="totalAmount" class="stat-value">$0.00</div>
</div>
<div class="stat-card">
<div class="stat-label">Pending</div>
<div id="pendingInvoices" class="stat-value">0</div>
</div>
</div>

<!-- ÁôºÁ•®ÂàóË°® -->
<div id="invoicesContainer" class="invoices-container"></div>
</div>
</div>

<style>
.filter-container {
display: flex;
align-items: center;
gap: 10px;
margin: 20px 0;
padding: 15px;
background-color: #f8f9fa;
border-radius: 8px;
}

.filter-container label {
font-weight: bold;
color: #264653;
}

#searchInput, #dateFilter {
padding: 8px 12px;
border: 2px solid #2a9d8f;
border-radius: 4px;
font-size: 1em;
}

#searchInput:focus, #dateFilter:focus {
outline: none;
border-color: #21867a;
}

.btn-clear {
padding: 8px 20px;
background-color: #6c757d;
color: white;
border: none;
border-radius: 4px;
cursor: pointer;
font-size: 1em;
}

.btn-clear:hover {
background-color: #5a6268;
}

.stats-container {
display: flex;
gap: 15px;
margin: 20px 0;
}

.stat-card {
flex: 1;
background: linear-gradient(135deg, #2a9d8f 0%, #21867a 100%);
color: white;
padding: 20px;
border-radius: 8px;
text-align: center;
box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.stat-label {
font-size: 0.9em;
opacity: 0.9;
margin-bottom: 10px;
}

.stat-value {
font-size: 2em;
font-weight: bold;
}

.invoices-container {
margin-top: 20px;
min-height: 200px;
}

.date-group {
margin-bottom: 30px;
}

.date-header {
background-color: #264653;
color: white;
padding: 12px 20px;
border-radius: 8px;
font-weight: bold;
font-size: 1.1em;
margin-bottom: 15px;
display: flex;
justify-content: space-between;
align-items: center;
}

.date-count {
background-color: rgba(255,255,255,0.2);
padding: 5px 15px;
border-radius: 20px;
font-size: 0.9em;
}

.invoice-card {
background-color: #f9f9f9;
border: 1px solid #ddd;
border-radius: 8px;
padding: 15px;
margin-bottom: 10px;
cursor: pointer;
transition: all 0.2s;
}

.invoice-card:hover {
transform: translateX(5px);
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
background-color: #f0f0f0;
}

.invoice-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 10px;
}

.invoice-number {
font-weight: bold;
font-size: 1.2em;
color: #264653;
}

.invoice-status {
padding: 5px 15px;
border-radius: 20px;
font-size: 0.9em;
font-weight: bold;
}

.status-pending {
background-color: #ffd60a;
color: #333;
}

.status-completed {
background-color: #52b788;
color: white;
}

.status-cancelled {
background-color: #e76f51;
color: white;
}

.invoice-details {
color: #666;
font-size: 0.95em;
display: flex;
justify-content: space-between;
align-items: center;
}

.invoice-info {
flex: 1;
}

.invoice-info div {
margin: 5px 0;
}

.invoice-customer {
font-weight: bold;
color: #2a9d8f;
font-size: 1.05em;
}

.invoice-items-count {
color: #666;
font-size: 0.9em;
}

.invoice-total {
font-weight: bold;
color: #e76f51;
font-size: 1.5em;
text-align: right;
}

.no-results {
text-align: center;
padding: 40px;
color: #666;
font-size: 1.1em;
}
</style>

<script>
let currentSearchTerm = '';
let currentDateFilter = '';
let allInvoices = [];
let filteredInvoices = [];

// È†ÅÈù¢ËºâÂÖ•ÊôÇÁç≤ÂèñÁôºÁ•®
window.addEventListener('DOMContentLoaded', function() {
console.log('Invoices page loaded');
loadInvoices();
});

// ËôïÁêÜÊêúÁ¥¢Ê°ÜÁöÑ Enter Èçµ
function handleSearch(event) {
if (event.key === 'Enter') {
searchInvoices();
}
}

// ÊêúÁ¥¢ÁôºÁ•®
function searchInvoices() {
const searchInput = document.getElementById('searchInput');
currentSearchTerm = searchInput.value.trim();
applyFilters();
}

// ÊåâÊó•ÊúüÁØ©ÈÅ∏
function filterByDate() {
const dateInput = document.getElementById('dateFilter');
currentDateFilter = dateInput.value;
applyFilters();
}

// Ê∏ÖÈô§ÁØ©ÈÅ∏
function clearFilters() {
document.getElementById('searchInput').value = '';
document.getElementById('dateFilter').value = '';
currentSearchTerm = '';
currentDateFilter = '';
filteredInvoices = allInvoices;
updateStats();
displayInvoicesByDate();
}

// ÊáâÁî®ÁØ©ÈÅ∏
function applyFilters() {
filteredInvoices = allInvoices.filter(invoice => {
let matchSearch = true;
let matchDate = true;

if (currentSearchTerm) {
matchSearch = invoice.invoice_number.toLowerCase().includes(currentSearchTerm.toLowerCase()) ||
invoice.customer_name.toLowerCase().includes(currentSearchTerm.toLowerCase());
}

if (currentDateFilter) {
matchDate = invoice.delivery_date === currentDateFilter;
}

return matchSearch && matchDate;
});

updateStats();
displayInvoicesByDate();
}

// ËºâÂÖ•ÁôºÁ•®ÂàóË°®
function loadInvoices() {
console.log('Fetching invoices from: /api/invoices');

fetch('/api/invoices')
.then(response => {
console.log('Response status:', response.status);
if (!response.ok) {
throw new Error('Network response was not ok');
}
return response.json();
})
.then(invoices => {
console.log('Received invoices:', invoices.length);
allInvoices = invoices;
filteredInvoices = invoices;
updateStats();
displayInvoicesByDate();
})
.catch(error => {
console.error('Error loading invoices:', error);
const container = document.getElementById('invoicesContainer');
if (container) {
container.innerHTML =
'<div class="no-results" style="color: red;">Failed to load invoices: ' + error.message + '</div>';
}
});
}

// Êõ¥Êñ∞Áµ±Ë®àÊï∏Êìö
function updateStats() {
const totalInvoices = filteredInvoices.length;
const totalAmount = filteredInvoices.reduce((sum, inv) => sum + inv.total_amount, 0);
const pendingCount = filteredInvoices.filter(inv => inv.status === 'Pending').length;

document.getElementById('totalInvoices').textContent = totalInvoices;
document.getElementById('totalAmount').textContent = `$${totalAmount.toFixed(2)}`;
document.getElementById('pendingInvoices').textContent = pendingCount;
}

// ÊåâÈÄÅË≤®Êó•ÊúüÈ°ØÁ§∫ÁôºÁ•®
function displayInvoicesByDate() {
const container = document.getElementById('invoicesContainer');
if (!container) {
console.error('invoicesContainer element not found!');
return;
}
container.innerHTML = '';

if (filteredInvoices.length === 0) {
container.innerHTML = '<div class="no-results">No invoice data available</div>';
return;
}

// ÊåâÈÄÅË≤®Êó•ÊúüÂàÜÁµÑ
const invoicesByDate = {};
filteredInvoices.forEach(invoice => {
const date = invoice.delivery_date;
if (!invoicesByDate[date]) {
invoicesByDate[date] = [];
}
invoicesByDate[date].push(invoice);
});

// ÊåâÊó•ÊúüÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
const sortedDates = Object.keys(invoicesByDate).sort((a, b) => b.localeCompare(a));

// È°ØÁ§∫ÊØèÂÄãÊó•ÊúüÁöÑÁôºÁ•®
sortedDates.forEach(date => {
const invoices = invoicesByDate[date];
const dateGroup = document.createElement('div');
dateGroup.className = 'date-group';

const dateHeader = document.createElement('div');
dateHeader.className = 'date-header';
dateHeader.innerHTML = `
<span>üìÖ Delivery Date: ${date}</span>
<span class="date-count">${invoices.length} invoices</span>
`;
dateGroup.appendChild(dateHeader);

invoices.forEach(invoice => {
const invoiceCard = document.createElement('div');
invoiceCard.className = 'invoice-card';
invoiceCard.onclick = () => viewInvoice(invoice.id);

const statusClass = `status-${invoice.status.toLowerCase()}`;

invoiceCard.innerHTML = `
<div class="invoice-header">
<div class="invoice-number">${invoice.invoice_number}</div>
<div class="invoice-status ${statusClass}">${invoice.status}</div>
</div>
<div class="invoice-details">
<div class="invoice-info">
<div class="invoice-customer">Customer: ${invoice.customer_name}</div>
<div class="invoice-items-count">üì¶ ${invoice.items_count} products</div>
<div style="font-size: 0.85em; color: #999; margin-top: 5px;">Created: ${invoice.created_date}</div>
</div>
<div class="invoice-total">$${invoice.total_amount.toFixed(2)}</div>
</div>
`;
dateGroup.appendChild(invoiceCard);
});

container.appendChild(dateGroup);
});
}

// Êü•ÁúãÁôºÁ•®Ë©≥ÊÉÖ
function viewInvoice(invoiceId) {
console.log('Viewing invoice:', invoiceId);
window.location.href = `/invoices/edit/${invoiceId}`;
}
</script>
{% endblock %}