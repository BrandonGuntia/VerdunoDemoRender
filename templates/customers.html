{% extends "base.html" %}
{% block title %}Customer DataBase{% endblock %}
{% block content %}
<div class="main">
<div class="card">
<h2>Welcome to Customer DataBase</h2>

<!-- æœç´¢æ¬„ -->
<div class="search-container">
<input id="searchInput" type="text" placeholder="ğŸ” Search by ID or Name..." onkeyup="handleSearch(event)">
<button onclick="searchCustomers()" class="btn-search">Search</button>
<button onclick="clearSearch()" class="btn-clear">Clear</button>
</div>

<div id="customerContainer" class="customer-container"></div>

<h3>Add Customer</h3>
<input id="name" placeholder="Customer Name">
<input id="email" placeholder="Email" type="email">
<input id="password" placeholder="Password" type="password">
<textarea id="specialItems" placeholder="Special Item IDs (é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚: PROD001, PROD002)" rows="3"></textarea>
<button onclick="add_customer()">Add</button>
</div>
</div>
<style>
.search-container {
display: flex;
gap: 10px;
margin: 20px 0;
}

#searchInput {
display: block;
width: 100%;
margin: 10px 0;
padding: 8px;
border: 1px solid #ccc;
border-radius: 4px;
box-sizing: border-box;
}

#searchInput:focus {
outline: none;
border-color: #21867a;
box-shadow: 0 0 5px rgba(42, 157, 143, 0.3);
}

.btn-search {
padding: 10px 20px;
background-color: #2a9d8f;
color: white;
border: none;
border-radius: 4px;
cursor: pointer;
font-size: 1em;
}

.btn-search:hover {
background-color: #21867a;
}

.btn-clear {
padding: 10px 20px;
background-color: #6c757d;
color: white;
border: none;
border-radius: 4px;
cursor: pointer;
font-size: 1em;
}

.btn-clear:hover {
background-color: #5a6268;
}

.customer-container {
display: flex;
flex-wrap: wrap;
gap: 12px;
margin-top: 20px;
min-height: 100px;
}

.customer-card {
border: 1px solid #ccc;
border-radius: 8px;
padding: 12px;
width: calc(33% - 12px);
box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
text-align: center;
background-color: #f9f9f9;
transition: transform 0.2s, box-shadow 0.2s;
cursor: pointer;
}

.customer-card:hover {
transform: translateY(-3px);
box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
background-color: #f0f0f0;
}

.customer-id {
font-size: 0.8em;
color: #666;
margin-bottom: 4px;
}

.customer-name {
font-weight: bold;
font-size: 1.1em;
margin-bottom: 8px;
color: #264653;
}

.customer-email {
color: #2a9d8f;
font-size: 0.9em;
margin-bottom: 8px;
}

.customer-special-items {
font-size: 0.85em;
color: #e76f51;
margin-top: 8px;
padding-top: 8px;
border-top: 1px solid #ddd;
}

.special-items-count {
font-weight: bold;
color: #e76f51;
}

input, textarea {
display: block;
width: 100%;
margin: 10px 0;
padding: 8px;
border: 1px solid #ccc;
border-radius: 4px;
box-sizing: border-box;
font-family: inherit;
}

button {
width: 100%;
padding: 10px;
background-color: #2a9d8f;
color: white;
border: none;
border-radius: 4px;
cursor: pointer;
font-size: 1em;
}

button:hover {
background-color: #21867a;
}

.no-results {
text-align: center;
padding: 40px;
color: #666;
font-size: 1.1em;
width: 100%;
}
</style>
<script>
let currentSearchTerm = '';

// é é¢è¼‰å…¥æ™‚è‡ªå‹•ç²å–å®¢æˆ¶è³‡æ–™
window.addEventListener('DOMContentLoaded', function() {
loadCustomers();
});

// è™•ç†æœç´¢æ¡†çš„ Enter éµ
function handleSearch(event) {
if (event.key === 'Enter') {
searchCustomers();
}
}

// æœç´¢å®¢æˆ¶
function searchCustomers() {
const searchInput = document.getElementById('searchInput');
currentSearchTerm = searchInput.value.trim();
loadCustomers(currentSearchTerm);
}

// æ¸…é™¤æœç´¢
function clearSearch() {
document.getElementById('searchInput').value = '';
currentSearchTerm = '';
loadCustomers();
}

// è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
function loadCustomers(searchTerm = '') {
let url = '/api/customers?limit=100'; // å¢åŠ é™åˆ¶ä»¥é¡¯ç¤ºæ›´å¤šæœç´¢çµæœ
if (searchTerm) {
url += `&search=${encodeURIComponent(searchTerm)}`;
}

fetch(url)
.then(response => {
if (!response.ok) {
throw new Error('Network response was not ok');
}
return response.json();
})
.then(customers => {
const container = document.getElementById('customerContainer');
container.innerHTML = '';

if (customers.length === 0) {
if (searchTerm) {
container.innerHTML = `<div class="no-results">æ‰¾ä¸åˆ°ç¬¦åˆ "${searchTerm}" çš„å®¢æˆ¶</div>`;
} else {
container.innerHTML = '<p class="no-results">ç›®å‰æ²’æœ‰å®¢æˆ¶è³‡æ–™</p>';
}
return;
}

customers.forEach(customer => {
const customerCard = document.createElement('div');
customerCard.className = 'customer-card';
customerCard.onclick = () => editCustomer(customer.id);

const specialItemsCount = customer.special_item_ids ? customer.special_item_ids.length : 0;
const specialItemsText = specialItemsCount > 0 
? `<span class="special-items-count">${specialItemsCount}</span> å€‹ç‰¹æ®Šç”¢å“` 
: 'ç„¡ç‰¹æ®Šç”¢å“';

customerCard.innerHTML = `
<div class="customer-id">ID: ${customer.id}</div>
<div class="customer-name">${customer.name}</div>
<div class="customer-email">${customer.email}</div>
<div class="customer-special-items">${specialItemsText}</div>
`;
container.appendChild(customerCard);
});
})
.catch(error => {
console.error('Error loading customers:', error);
document.getElementById('customerContainer').innerHTML =
'<p style="color: red;">è¼‰å…¥å®¢æˆ¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
});
}

// é»æ“Šå®¢æˆ¶å¡ç‰‡ï¼Œè·³è½‰åˆ°ç·¨è¼¯é é¢
function editCustomer(customerId) {
window.location.href = `/customers/edit/${customerId}`;
}

// æ·»åŠ å®¢æˆ¶
function add_customer() {
const name = document.getElementById('name').value;
const email = document.getElementById('email').value;
const password = document.getElementById('password').value;
const specialItemsInput = document.getElementById('specialItems').value;

if (!name || !email || !password) {
alert('è«‹å¡«å¯«åç¨±ã€é›»å­éƒµä»¶å’Œå¯†ç¢¼');
return;
}

// å¯†ç¢¼é•·åº¦é©—è­‰
if (password.length < 6) {
alert('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ');
return;
}

// ç°¡å–®çš„é›»å­éƒµä»¶é©—è­‰
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
if (!emailRegex.test(email)) {
alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€');
return;
}

// è™•ç†ç‰¹æ®Šç”¢å“ ID
let specialItems = [];
if (specialItemsInput.trim()) {
specialItems = specialItemsInput.split(',').map(item => item.trim()).filter(item => item);
if (specialItems.length > 99) {
alert('ç‰¹æ®Šç”¢å“ ID æ•¸é‡ä¸èƒ½è¶…é 99 å€‹');
return;
}
}

fetch('/api/customers', {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify({
name: name,
email: email,
password: password,
special_item_ids: specialItems
})
})
.then(response => {
if (!response.ok) {
return response.json().then(err => {
throw new Error(err.message || 'Network response was not ok');
});
}
return response.json();
})
.then(data => {
alert(data.message);
document.getElementById('name').value = '';
document.getElementById('email').value = '';
document.getElementById('password').value = '';
document.getElementById('specialItems').value = '';
loadCustomers(currentSearchTerm);
})
.catch(error => {
console.error('Error adding customer:', error);
alert('æ·»åŠ å®¢æˆ¶å¤±æ•—: ' + error.message);
});
}
</script>
{% endblock %}