{% extends "base.html" %}
{% block title %}Invoice Details{% endblock %}
{% block content %}
<div class="main">
<div class="card">
<h2>üìÑ Invoice Details</h2>
<div id="loading">Loading...</div>
<div id="invoiceDetails" style="display: none;">
<!-- ÁôºÁ•®‰ø°ÊÅØ -->
<div class="invoice-info-section">
<div class="info-row">
<span class="info-label">Invoice Number:</span>
<span id="invoiceNumber" class="info-value"></span>
</div>
<div class="info-row">
<span class="info-label">Created Date:</span>
<span id="createdDate" class="info-value"></span>
</div>
<div class="info-row">
<span class="info-label">Delivery Date:</span>
<input id="deliveryDate" type="date" class="date-input">
</div>
<div class="info-row">
<span class="info-label">Status:</span>
<select id="status" class="status-select">
<option value="Pending">Pending</option>
<option value="Completed">Completed</option>
<option value="Cancelled">Cancelled</option>
</select>
</div>
</div>

<!-- ÂÆ¢Êà∂‰ø°ÊÅØ -->
<div class="section-title">Customer Information</div>
<div class="invoice-info-section">
<div class="info-row">
<span class="info-label">Customer ID:</span>
<span id="customerId" class="info-value"></span>
</div>
<div class="info-row">
<span class="info-label">Customer Name:</span>
<span id="customerName" class="info-value"></span>
</div>
<div class="info-row">
<span class="info-label">Email:</span>
<span id="customerEmail" class="info-value"></span>
</div>
</div>

<!-- Ë®ÇÂñÆÈ†ÖÁõÆ -->
<div class="section-title">Order Items</div>
<div id="orderItemsContainer"></div>

<!-- Á∏ΩÂÉπ -->
<div class="total-section">
<div class="total-label">Total Amount:</div>
<div id="totalPrice" class="total-value"></div>
</div>

<!-- ÊåâÈàïÁµÑ -->
<div class="button-group">
<button onclick="updateInvoice()" class="btn-primary">Update</button>
<button onclick="downloadPDF()" class="btn-pdf">Download PDF</button>
<button onclick="deleteInvoice()" class="btn-danger">Delete</button>
<button onclick="goBack()" class="btn-secondary">Back</button>
</div>
</div>
</div>
</div>

<style>
.invoice-info-section {
background-color: #f8f9fa;
border: 1px solid #ddd;
border-radius: 8px;
padding: 20px;
margin-bottom: 20px;
}

.section-title {
font-size: 1.2em;
font-weight: bold;
color: #264653;
margin: 25px 0 15px 0;
padding-bottom: 10px;
border-bottom: 2px solid #2a9d8f;
}

.info-row {
display: flex;
justify-content: space-between;
align-items: center;
padding: 10px 0;
border-bottom: 1px solid #e0e0e0;
}

.info-row:last-child {
border-bottom: none;
}

.info-label {
font-weight: bold;
color: #666;
flex: 0 0 200px;
}

.info-value {
color: #264653;
flex: 1;
text-align: right;
}

.status-select {
padding: 8px 15px;
border: 2px solid #2a9d8f;
border-radius: 4px;
font-size: 1em;
background-color: white;
cursor: pointer;
}

.status-select:focus {
outline: none;
border-color: #21867a;
}

.date-input {
padding: 8px 15px;
border: 2px solid #2a9d8f;
border-radius: 4px;
font-size: 1em;
background-color: white;
cursor: pointer;
flex: 1;
text-align: right;
}

.date-input:focus {
outline: none;
border-color: #21867a;
}

#orderItemsContainer {
background-color: #fff;
border: 1px solid #ddd;
border-radius: 8px;
overflow: hidden;
}

.order-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 15px;
border-bottom: 1px solid #e0e0e0;
}

.order-item:last-child {
border-bottom: none;
}

.order-item:nth-child(even) {
background-color: #f8f9fa;
}

.item-info {
flex: 1;
}

.item-name {
font-weight: bold;
color: #264653;
margin-bottom: 5px;
}

.item-details {
font-size: 0.9em;
color: #666;
}

.item-quantity {
width: 80px;
margin: 0 15px;
}

.item-quantity input {
width: 100%;
padding: 8px;
border: 2px solid #2a9d8f;
border-radius: 4px;
text-align: center;
}

.item-price {
min-width: 120px;
text-align: right;
}

.item-unit-price {
font-size: 0.9em;
color: #666;
}

.item-total-price {
font-size: 1.2em;
font-weight: bold;
color: #e76f51;
}

.total-section {
background-color: #264653;
color: white;
padding: 20px;
border-radius: 8px;
margin: 30px 0 20px 0;
display: flex;
justify-content: space-between;
align-items: center;
}

.total-label {
font-size: 1.3em;
font-weight: bold;
}

.total-value {
font-size: 2em;
font-weight: bold;
}

.button-group {
display: flex;
gap: 10px;
margin-top: 25px;
}

button {
flex: 1;
padding: 12px;
border: none;
border-radius: 4px;
cursor: pointer;
font-size: 1em;
font-weight: bold;
}

.btn-primary {
background-color: #2a9d8f;
color: white;
}

.btn-primary:hover {
background-color: #21867a;
}

.btn-pdf {
background-color: #e63946;
color: white;
}

.btn-pdf:hover {
background-color: #d62839;
}

.btn-danger {
background-color: #e76f51;
color: white;
}

.btn-danger:hover {
background-color: #d15b42;
}

.btn-secondary {
background-color: #6c757d;
color: white;
}

.btn-secondary:hover {
background-color: #5a6268;
}

#loading {
text-align: center;
padding: 40px;
color: #666;
font-size: 1.1em;
}
</style>

<script>
let currentInvoiceId = null;
let currentInvoice = null;

// Âæû URL Áç≤ÂèñÁôºÁ•® ID
window.addEventListener('DOMContentLoaded', function() {
const pathParts = window.location.pathname.split('/');
currentInvoiceId = pathParts[pathParts.length - 1];
console.log('Invoice ID from URL:', currentInvoiceId);
loadInvoice();
});

// ËºâÂÖ•ÁôºÁ•®Ë≥áÊñô
function loadInvoice() {
console.log('Fetching invoice:', currentInvoiceId);
fetch(`/api/invoices/${currentInvoiceId}`)
.then(response => {
console.log('Response status:', response.status);
if (!response.ok) {
throw new Error('Invoice not found');
}
return response.json();
})
.then(invoice => {
console.log('Invoice data:', invoice);
currentInvoice = invoice;
displayInvoice(invoice);
document.getElementById('loading').style.display = 'none';
document.getElementById('invoiceDetails').style.display = 'block';
})
.catch(error => {
console.error('Error loading invoice:', error);
document.getElementById('loading').innerHTML = 
`<p style="color: red;">Failed to load invoice: ${error.message}</p>
<p><a href="/invoices">Back to invoice list</a></p>`;
});
}

// È°ØÁ§∫ÁôºÁ•®Ë≥áÊñô
function displayInvoice(invoice) {
document.getElementById('invoiceNumber').textContent = invoice.invoice_number;
document.getElementById('createdDate').textContent = invoice.created_date;
document.getElementById('deliveryDate').value = invoice.delivery_date;
document.getElementById('status').value = invoice.status;
document.getElementById('customerId').textContent = invoice.customer_id;
document.getElementById('customerName').textContent = invoice.customer_name;
document.getElementById('customerEmail').textContent = invoice.customer_email;

// È°ØÁ§∫Ë®ÇÂñÆÈ†ÖÁõÆ
const itemsContainer = document.getElementById('orderItemsContainer');
itemsContainer.innerHTML = '';

invoice.items.forEach((item, index) => {
const itemDiv = document.createElement('div');
itemDiv.className = 'order-item';
itemDiv.innerHTML = `
<div class="item-info">
<div class="item-name">${item.product_name}</div>
<div class="item-details">Product ID: ${item.product_id} | Category: ${item.product_subclass}</div>
</div>
<div class="item-quantity">
<input type="number" min="1" value="${item.quantity}" 
       onchange="updateItemQuantity(${item.id}, this.value)">
</div>
<div class="item-price">
<div class="item-unit-price">Unit: ${item.unit_price.toFixed(2)}</div>
<div class="item-total-price">${item.total_price.toFixed(2)}</div>
</div>
`;
itemsContainer.appendChild(itemDiv);
});

updateTotalPrice();
}

// Êõ¥Êñ∞È†ÖÁõÆÊï∏Èáè
function updateItemQuantity(itemId, newQuantity) {
const quantity = parseInt(newQuantity);
if (!quantity || quantity <= 0) {
alert('Please enter a valid quantity');
loadInvoice(); // ÈáçÊñ∞ËºâÂÖ•‰ª•ÊÅ¢Âæ©ÂéüÂÄº
return;
}

// Âú®Áï∂ÂâçÁôºÁ•®Êï∏Êìö‰∏≠Êõ¥Êñ∞
const item = currentInvoice.items.find(i => i.id === itemId);
if (item) {
item.quantity = quantity;
item.total_price = item.unit_price * quantity;
updateTotalPrice();
}
}

// Êõ¥Êñ∞Á∏ΩÂÉπÈ°ØÁ§∫
function updateTotalPrice() {
const total = currentInvoice.items.reduce((sum, item) => sum + item.total_price, 0);
currentInvoice.total_amount = total;
document.getElementById('totalPrice').textContent = `${total.toFixed(2)}`;
}

// Êõ¥Êñ∞ÁôºÁ•®
function updateInvoice() {
const status = document.getElementById('status').value;
const deliveryDate = document.getElementById('deliveryDate').value;

const updateData = {
status: status,
delivery_date: deliveryDate,
items: currentInvoice.items.map(item => ({
id: item.id,
quantity: item.quantity
}))
};

fetch(`/api/invoices/${currentInvoiceId}`, {
method: 'PUT',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(updateData)
})
.then(response => {
if (!response.ok) {
throw new Error('Update failed');
}
return response.json();
})
.then(data => {
alert('Invoice updated successfully!');
loadInvoice();
})
.catch(error => {
console.error('Error updating invoice:', error);
alert('Failed to update invoice');
});
}

// ‰∏ãËºâ PDF
function downloadPDF() {
window.open(`/api/invoices/${currentInvoiceId}/pdf`, '_blank');
}

// Âà™Èô§ÁôºÁ•®
function deleteInvoice() {
if (!confirm('Are you sure you want to delete this invoice? This action cannot be undone!')) {
return;
}

fetch(`/api/invoices/${currentInvoiceId}`, {
method: 'DELETE'
})
.then(response => {
if (!response.ok) {
throw new Error('Delete failed');
}
return response.json();
})
.then(data => {
alert('Invoice deleted successfully!');
window.location.href = '/invoices';
})
.catch(error => {
console.error('Error deleting invoice:', error);
alert('Failed to delete invoice');
});
}

// ËøîÂõûÁôºÁ•®ÂàóË°®
function goBack() {
window.location.href = '/invoices';
}
</script>
{% endblock %}